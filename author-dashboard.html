<!DOCTYPE html>
<html>
<head>
  <title>Author Dashboard - SKY Bus</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial; background: #f5f5f5; padding: 20px; }
    .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    input, button, select { width: 100%; padding: 10px; margin: 10px 0; }
    .bus-card { border: 1px solid #ccc; padding: 15px; margin: 10px 0; background: #f0f8ff; border-radius: 6px; }
    h2 { text-align: center; }
    .edit-btn { background: orange; border: none; color: white; padding: 8px; cursor: pointer; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üöå Author Dashboard</h2>

    <div id="authorForm">
      <h3>Add New Bus</h3>
      <input type="text" id="busName" placeholder="Bus Name (e.g. SRM Express)" required />
      <input type="text" id="from" placeholder="From City" required />
      <input type="text" id="to" placeholder="To City" required />
      <input type="text" id="boarding" placeholder="Boarding Point" required />
      <input type="text" id="departure" placeholder="Departure Point" required />
      <input type="date" id="date" required />
      <input type="time" id="time" required />
      <input type="number" id="priceAC" placeholder="Price - AC" required />
      <input type="number" id="priceNonAC" placeholder="Price - Non-AC" required />
      <input type="number" id="priceSleeper" placeholder="Price - Sleeper" required />
      <input type="number" id="seats" placeholder="Total Seats" required />
      <button onclick="addBus()">‚ûï Add Bus</button>
    </div>

    <div id="busList">
      <h3>üóÇÔ∏è Your Buses</h3>
      <!-- Bus items will show here -->
    </div>
  </div>

  <script>
    const supabase = supabase.createClient('https://kttdmdmbakgjzyqfejbi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0dGRtZG1iYWtnanp5cWZlamJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1MDk2MDEsImV4cCI6MjA2NzA4NTYwMX0.ncfKBBY99Iad8qLqzD3ingzYivmAQqaLvAJrwqePJOs');
    let currentUserId = null;

    async function checkAuthor() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) {
        alert("‚ùå Please login first");
        window.location.href = "login.html";
        return;
      }

      const email = session.user.email;
      currentUserId = session.user.id;

      // Allow only emails from specific domain
      if (!email.endsWith("@skybus.com")) {
        alert("‚ùå Access denied: Not an Author");
        window.location.href = "index.html";
        return;
      }

      loadBuses();
    }

    async function addBus() {
      const bus = {
        author_id: currentUserId,
        name: document.getElementById("busName").value,
        from: document.getElementById("from").value,
        to: document.getElementById("to").value,
        boarding_point: document.getElementById("boarding").value,
        departure_point: document.getElementById("departure").value,
        date: document.getElementById("date").value,
        departure_time: document.getElementById("time").value,
        price_ac: +document.getElementById("priceAC").value,
        price_non_ac: +document.getElementById("priceNonAC").value,
        price_sleeper: +document.getElementById("priceSleeper").value,
        total_seats: +document.getElementById("seats").value
      };

      const { error } = await supabase.from("buses").insert(bus);
      if (error) {
        alert("‚ùå Error: " + error.message);
      } else {
        alert("‚úÖ Bus added!");
        loadBuses();
      }
    }

    async function loadBuses() {
      const { data: buses, error } = await supabase
        .from("buses")
        .select("*")
        .eq("author_id", currentUserId)
        .order("date", { ascending: true });

      const container = document.getElementById("busList");
      container.innerHTML = "<h3>üóÇÔ∏è Your Buses</h3>";

      buses.forEach(bus => {
        const div = document.createElement("div");
        div.className = "bus-card";
        div.innerHTML = `
          <strong>${bus.name}</strong><br/>
          Route: ${bus.from} ‚Üí ${bus.to}<br/>
          Boarding: ${bus.boarding_point}, Departure: ${bus.departure_point}<br/>
          Time: ${bus.date} at ${bus.departure_time}<br/>
          üí∫ AC: ‚Çπ${bus.price_ac}, Non-AC: ‚Çπ${bus.price_non_ac}, Sleeper: ‚Çπ${bus.price_sleeper}<br/>
          Seats: ${bus.total_seats}
        `;
        container.appendChild(div);
      });
    }

    checkAuthor();
  </script>
</body>
</html>